# 6.AK 的 CI/CD

## 介绍

你现在在这本书的最后一章。到目前为止，您已经了解了微服务和 Azure Kubernetes 服务的设计考虑事项。您几乎已经准备好监控和保护一个基于 Azure Kubernetes 服务的应用程序。在这最后一章中，您将了解应用程序交付的一个重要方面，持续集成和持续部署，重点是基于 Azure Kubernetes 服务的应用程序。

## 快速浏览 DevOps

我假设您对这个主题并不陌生，但是在开始这一章之前，我先简单介绍一下 DevOps。

DevOps 将人员、流程和技术结合在一起，自动化软件交付，为您的用户提供持续的价值。DevOps 自动化并加速软件交付。它使您的过程和产品更加可靠。

DevOps 是一个过程，一种实践，一套工具或所有工具的总和。它共同致力于一个组织所采用的更快的软件/产品交付。它在很大程度上放大了团队的统一性，有助于使开发阶段无缝衔接。它受欢迎的主要原因是交付速度更快。您在存储库中编码和添加，CI 用最新的更改构建应用程序，并向它提供一个可部署的工件。这个工件现在被获取并实时推送，所有这些都是 CD 流程的一部分。这可以在您工作的所有环境中进行。同样的工件可以被提升到更高的环境，比如从开发到 QA 到 UAT 到生产。

Note

如果你是 DevOps 概念的初学者，最好浏览一下在 [`https://docs.microsoft.com/en-us/learn/modules/get-started-with-devops/2-what-is-devops`](https://docs.microsoft.com/en-us/learn/modules/get-started-with-devops/2-what-is-devops) 找到的文档。

为了让这最后一章更有趣，我用一步一步的方法来介绍这个练习。理论少，实际应用多。我相信这不仅会使你的学习变得有趣，而且会帮助你更容易理解这个话题。& # x1F60A

作为以下练习的先决条件的一部分，您需要在您的计算机上安装有效的 Microsoft Azure 订阅、Visual Studio 作为 IDE、Azure DevOps 项目和 Docker Desktop for Windows。该练习使用 GitHub 作为源代码库。

## 本次练习的目标

以下是本次练习的日程安排:

*   使用 Azure Portal 创建 Azure Kubernetes 服务。

*   使用 Azure Portal 创建 Azure 容器实例。

*   使用 Visual Studio 构建示例应用程序。

您可以使用各种工具实现 CI/CD，但如果您是微软云爱好者，以下工具是最佳选择:

*   Azure DevOps

*   GitHub 动作

本章向您介绍了使用 Azure DevOps 的步骤。对于 GitHub 动作，你会得到一个参考链接，你可以把它作为本章的第一个练习。本章中的大多数详细步骤都是不言自明的，但是我会在需要的地方包含更多的细节。

所以做好准备，按照这些步骤来做吧！& # x1F60A

## 使用 Azure 门户创建 Azure Kubernetes 服务

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig1_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig1_HTML.jpg)

图 6-1

图像细节步骤 1

1.  从 [`http://portal.azure.com/`](http://portal.azure.com/) 打开微软 Azure 门户，点击创建资源链接，如图 [6-1](#Fig1) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig2_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig2_HTML.jpg)

图 6-2

图像细节步骤 2

1.  在搜索框中搜索 Kubernetes 服务，或者导航到计算➤ Kubernetes 服务，点击列出的服务，如图 [6-2](#Fig2) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig3_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig3_HTML.jpg)

图 6-3

图像细节步骤 3

1.  您将看到输入基本细节的屏幕。详细信息，如选择您的订阅、资源组、集群名称、区域等。这个例子使用的是 Kubernetes 版本 1.19.11。输入所有必需的详细信息，然后单击节点池的下一步。见图 [6-3](#Fig3) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig4_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig4_HTML.jpg)

图 6-4

图像细节步骤 04

1.  现在，您将添加一个节点池。单击+添加节点池按钮。您会看到多个选项，如图 [6-4](#Fig4) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig5_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig5_HTML.jpg)

图 6-5

图像细节步骤 5

1.  给出节点池名称，然后选择虚拟机大小，如图 [6-5](#Fig5) 所示。您不必选择与图中所示相同的虚拟机大小。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig6_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig6_HTML.png)

图 6-6

图像细节步骤 6

1.  将列出新创建的节点。单击“下一步”转到身份验证。见图 [6-6](#Fig6) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig7_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig7_HTML.png)

图 6-7

图像细节步骤 7

1.  选择认证方式和 RBAC 角色，如图 [6-7](#Fig7) 所示。单击下一步。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig8_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig8_HTML.png)

图 6-8

图像细节步骤 8

1.  选择网络配置为 Azure CNI 等必填字段，如图 [6-8](#Fig8) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig9_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig9_HTML.png)

图 6-9

图像细节步骤 9

1.  确保选择 Azure 作为网络策略，如图 [6-9](#Fig9) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig10_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig10_HTML.jpg)

图 6-10

图像细节步骤 10

1.  单击“下一步”并显示集成细节。我会照原样去。点击'审核+创建'，如图 [6-10](#Fig10) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig11_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig11_HTML.png)

图 6-11

图像细节步骤 11

1.  验证通过后，点击【创建】，如图 [6-11](#Fig11) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig12_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig12_HTML.png)

图 6-12

图像细节步骤 12

1.  这将导致显示部署进度的屏幕。部署成功后，点击【转到资源】，如图 [6-12](#Fig12) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig13_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig13_HTML.png)

图 6-13

图像细节步骤 13

1.  您将看到新创建的 Kubernetes 集群，如图 [6-13](#Fig13) 所示。

## 使用 Azure 门户创建 Azure 容器实例

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig14_HTML.jpg](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig14_HTML.jpg)

图 6-14

图像细节步骤 14

1.  遵循图 [6-14](#Fig14) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig15_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig15_HTML.png)

图 6-15

图像细节步骤 15

1.  遵循图 [6-15](#Fig15) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig16_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig16_HTML.png)

图 6-16

图像细节步骤 16

1.  在基本屏幕上输入必需的详细信息，其余的设置为默认值。点击审核+创建，如图 [6-16](#Fig16) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig17_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig17_HTML.png)

图 6-17

图像细节步骤 17

1.  看到验证通过后，单击创建。见图 [6-17](#Fig17)

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig18_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig18_HTML.png)

图 6-18

图像细节步骤 18

1.  等待部署完成。点击进入资源，如图 [6-18](#Fig18) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig19_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig19_HTML.png)

图 6-19

图像细节步骤 19

1.  从左侧刀片中选择门禁，如图 [6-19](#Fig19) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig20_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig20_HTML.png)

图 6-20

图像细节步骤 20

1.  点击添加新的角色分配，如图 [6-20](#Fig20) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig21_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig21_HTML.png)

图 6-21

图像细节步骤 21

1.  选择呈现用户管理身份的Á远程角色，然后选择新创建的池，如图 [6-21](#Fig21) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig22_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig22_HTML.png)

图 6-22

图像细节步骤 22

1.  遵循图 [6-22](#Fig22) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig23_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig23_HTML.png)

图 6-23

图像细节步骤 23

1.  从左侧刀片，进入设置部分下的访问键，如图 [6-23](#Fig23) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig24_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig24_HTML.png)

图 6-24

图像细节步骤 24

1.  点击 Toggle 以管理员用户身份启用按键，如图 [6-24](#Fig24) 所示。

## 使用 Visual Studio 构建示例应用程序

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig25_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig25_HTML.png)

图 6-25

图像细节步骤 25

1.  在打开 IDE 之前，先去下面的链接下载 Docker 桌面，用默认设置安装: [`https://www.docker.com/products/docker-desktop`](https://www.docker.com/products/docker-desktop) (见图 [6-25](#Fig25) )。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig26_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig26_HTML.png)

图 6-26

图像细节步骤 26

1.  图 [6-26](#Fig26) 显示 Docker 已启动并运行。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig27_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig27_HTML.png)

图 6-27

图像细节步骤 27

1.  现在打开 Visual Studio，选择新建一个项目，如图 [6-27](#Fig27) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig28_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig28_HTML.png)

图 6-28

图像细节步骤 28

1.  遵循图 [6-28](#Fig28) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig29_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig29_HTML.png)

图 6-29

图像细节步骤 29

1.  选择应用程序的名称，如图 [6-29](#Fig29) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig30_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig30_HTML.png)

图 6-30

图像细节步骤 30

1.  确保启用 Docker 并选择 Windows 作为 Docker OS，如图 [6-30](#Fig30) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig31_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig31_HTML.png)

图 6-31

图像细节步骤 31

1.  您可以看到创建的应用程序，如图 [6-31](#Fig31) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig32_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig32_HTML.png)

图 6-32

图像细节步骤 32

1.  选择运行➤ Kubernetes 应用程序，如图 [6-32](#Fig32) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig33_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig33_HTML.png)

图 6-33

图像细节步骤 33

1.  点击运行应用程序，如图 [6-33](#Fig33) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig34_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig34_HTML.png)

图 6-34

图像细节步骤 34

1.  确保应用程序运行良好，没有错误。见图 [6-34](#Fig34) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig35_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig35_HTML.png)

图 6-35

图像细节步骤 35

1.  现在，通过右键单击并选择“添加➤新文件”来添加一个新文件。见图 [6-35](#Fig35) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig36_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig36_HTML.png)

图 6-36

图像细节步骤 36

1.  您必须添加这个 YAML 文件，因为它定义了 Kubernetes 中容器的部署细节。见图 [6-36](#Fig36)

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig37_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig37_HTML.png)

图 6-37

图像细节步骤 37

1.  您可以删除这个默认代码，并在下一步添加脚本。见图 [6-37](#Fig37) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig38_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig38_HTML.png)

图 6-38

图像细节步骤 38

1.  以下脚本定义了容器映像的详细信息、它必须创建的副本数量、要公开的端口、缩放指标和更新策略。见图 [6-38](#Fig38)

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig39_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig39_HTML.png)

图 6-39

图像细节步骤 39

1.  遵循图 [6-39](#Fig39) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig40_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig40_HTML.png)

图 6-40

图像细节步骤 40

1.  这个完整的脚本有助于构建容器应用程序。这是默认脚本，您可以根据需要更改它。见图 [6-40](#Fig40)

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig41_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig41_HTML.png)

图 6-41

图像细节步骤 41

1.  用图 [6-41](#Fig41) 中的脚本替换默认脚本。该脚本以 dotnet 核心容器映像为基础，构建容器应用程序。

您已经完成了对应用程序的必要更改。现在，您将构建用于设置 CI/CD 的管道。

## 使用 Azure DevOps 的 CI/CD

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig42_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig42_HTML.png)

图 6-42

图像细节步骤 42

1.  打开团队资源管理器，并遵循图 [6-42](#Fig42) 中所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig43_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig43_HTML.png)

图 6-43

图像细节步骤 43

1.  按照图 [6-43](#Fig43) 所示的步骤连接到 GitHub 存储库。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig44_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig44_HTML.png)

图 6-44

图像细节步骤 44

1.  认证你的 GitHub 凭证，如图 [6-44](#Fig44) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig45_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig45_HTML.png)

图 6-45

图像细节步骤 45

1.  一旦授权成功，您将看到如图 [6-45](#Fig45) 所示的信息。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig46_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig46_HTML.png)

图 6-46

图像细节步骤 46

1.  遵循图 [6-46](#Fig46) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig47_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig47_HTML.png)

图 6-47

图像细节步骤 47

1.  遵循图 [6-47](#Fig47) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig48_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig48_HTML.png)

图 6-48

图像细节步骤 48

1.  遵循图 [6-48](#Fig48) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig49_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig49_HTML.png)

图 6-49

图像细节步骤 49

1.  您创建的应用程序现在是您 repo 的一部分，并且可以看到文件，如图 [6-49](#Fig49) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig50_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig50_HTML.png)

图 6-50

图像细节步骤 50

1.  进入 [`https://devops.azure.com/`](https://devops.azure.com/) ，如图 [6-50](#Fig50) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig51_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig51_HTML.png)

图 6-51

图像细节步骤 51

1.  按照图 [6-51](#Fig51) 所示的步骤创建一个新项目。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig52_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig52_HTML.png)

图 6-52

图像细节步骤 52

1.  遵循图 [6-52](#Fig52) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig53_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig53_HTML.png)

图 6-53

图像细节步骤 53

1.  按照图 [6-53](#Fig53) 所示步骤启动管道。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig54_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig54_HTML.png)

图 6-54

图像细节步骤 54

1.  点击【创建管道】，如图 [6-54](#Fig54) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig55_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig55_HTML.png)

图 6-55

图像细节步骤 55

1.  挑选你的代码；本例使用经典编辑器，如图 [6-55](#Fig55) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig56_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig56_HTML.png)

图 6-56

图像细节步骤 56

1.  选择 GitHub，用你的 GitHub 凭证授权，如图 [6-56](#Fig56) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig57_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig57_HTML.png)

图 6-57

图像细节步骤 57

1.  选择存放您的应用程序文件的仓库，如图 [6-57](#Fig57) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig58_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig58_HTML.png)

图 6-58

图像细节步骤 58

1.  遵循图 [6-58](#Fig58) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig59_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig59_HTML.png)

图 6-59

图像细节步骤 59

1.  点击继续，如图 [6-59](#Fig59) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig60_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig60_HTML.png)

图 6-60

图像细节步骤 60

1.  添加新任务。这是一个 DevOps 管道任务，可以帮助您构建和推送容器映像。您需要使用此任务或任何其他此类任务来构建容器应用程序。见图 [6-60](#Fig60)

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig61_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig61_HTML.png)

图 6-61

图像细节步骤 61

1.  遵循图 [6-61](#Fig61) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig62_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig62_HTML.png)

图 6-62

图像细节步骤 62

1.  遵循图 [6-62](#Fig62) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig63_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig63_HTML.png)

图 6-63

图像细节步骤 63

1.  遵循图 [6-63](#Fig63) 中的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig64_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig64_HTML.png)

图 6-64

图像细节步骤 64

1.  授权您的订阅，如图 [6-64](#Fig64) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig65_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig65_HTML.png)

图 6-65

图像细节步骤 65

1.  遵循图 [6-65](#Fig65) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig66_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig66_HTML.png)

图 6-66

图像细节步骤 66

1.  选择路径，如图 [6-66](#Fig66) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig67_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig67_HTML.png)

图 6-67

图像细节步骤 67

1.  最好为每个构建创建一个新版本的容器，因为代码中的每个新变化都会构建一个容器。因此，为了保持映像版本的唯一性，请使用管道的构建 ID，该 ID 是管道每次运行构建操作时唯一生成的。图 [6-67](#Fig67) 中显示的前面带有＄的值是 DevOps 管道中的一个变量。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig68_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig68_HTML.png)

图 6-68

图像细节步骤 68

1.  遵循图 [6-68](#Fig68) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig69_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig69_HTML.png)

图 6-69

图像细节步骤 69

1.  这与前面提到的 Docker 映像的构建任务相同。您需要为将要推入 ACR 的 Docker 映像提供一个唯一的版本。因此，使用图 [6-69](#Fig69) 所示的变量。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig70_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig70_HTML.png)

图 6-70

图像细节步骤 70

1.  我们可以使用替换令牌任务来替换 Azure 容器注册表的 URL，它将用于存储容器图像。您不需要在源代码中对注册中心的 URL 进行硬编码，而是在 YAML 文件中创建一个变量，这个变量最初是为了定义部署到 Kubernetes 中的容器配置而添加的。每次运行时，您可以在管道中提供一个变量，以便在管道运行时，您可以定义容器注册表的详细信息。见图 [6-70](#Fig70)

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig71_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig71_HTML.png)

图 6-71

图像细节步骤 71

1.  遵循图 [6-71](#Fig71) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig72_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig72_HTML.png)

图 6-72

图像细节步骤 72

1.  选择路径，如图 [6-72](#Fig72) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig73_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig73_HTML.png)

图 6-73

图像细节步骤 73

1.  在这里，您列出了要替换变量的文件的详细信息，该变量是容器注册表名称。见图 [6-73](#Fig73) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig74_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig74_HTML.png)

图 6-74

图像细节步骤 74

1.  转到变量，点击添加按钮，如图 [6-74](#Fig74) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig75_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig75_HTML.png)

图 6-75

图像细节步骤 75

1.  添加ÁCR 作为新的变量名，添加来自 Azure 门户的 ACR 登录服务器 URL 作为值，如图 [6-75](#Fig75) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig76_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig76_HTML.png)

图 6-76

图像细节步骤 76

1.  在 Azure Portal 中，获取需要的 URL，如图 [6-76](#Fig76) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig77_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig77_HTML.png)

图 6-77

图像细节步骤 77

1.  粘贴变量名 ACR 的值，如图 [6-77](#Fig77) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig79_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig79_HTML.png)

图 6-79

图像细节步骤 79

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig78_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig78_HTML.png)

图 6-78

图像细节步骤 78

1.  添加名为复制文件的新任务名称。遵循图 [6-78](#Fig78) 所示的步骤。

1.  这是一个构建管道，用于构建您的代码，构建的工件将被提供给发布管道以发布代码。使用复制文件任务复制构建的工件。但是在这里，您没有构建任何工件，因为您在构建管道中将图像发送到容器注册表。您需要 YAML，因此您使用这个任务复制它，并将其作为工件发布，以便在发布管道中使用。参见图 [7-79](#Fig79) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig80_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig80_HTML.png)

图 6-80

图像细节步骤 80

1.  添加另一个名为发布构建工件的任务名称。遵循图 [6-80](#Fig80) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig81_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig81_HTML.png)

图 6-81

图像细节步骤 81

1.  按照图 [6-81](#Fig81) 所示的步骤进行发布任务。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig82_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig82_HTML.png)

图 6-82

图像细节步骤 82

1.  进入触发器部分，通过勾选选项启用持续集成，如图 [6-82](#Fig82) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig83_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig83_HTML.png)

图 6-83

图像细节步骤 83

1.  遵循图 [6-83](#Fig83) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig84_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig84_HTML.png)

图 6-84

图像细节步骤 84

1.  现在你将创建释放管道，如图 [6-84](#Fig84) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig85_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig85_HTML.png)

图 6-85

图像细节步骤 85

1.  部署到一个 Kubernetes 集群任务，如图 [6-85](#Fig85) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig86_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig86_HTML.png)

图 6-86

图像细节步骤 86

1.  给它起个名字，如图 [6-86](#Fig86) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig87_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig87_HTML.png)

图 6-87

图像细节步骤 87

1.  遵循图 [6-87](#Fig87) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig88_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig88_HTML.png)

图 6-88

图像细节步骤 88

1.  选择构建，并以您在前面步骤中创建的构建管道作为源来呈现它。参见图 [6-88](#Fig88) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig89_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig89_HTML.png)

图 6-89

图像细节步骤 89

1.  点击高亮图标，启用持续部署触发器，如图 [6-89](#Fig89) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig90_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig90_HTML.png)

图 6-90

图像细节步骤 90

1.  使用开关将其激活，如图 [6-90](#Fig90) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig91_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig91_HTML.png)

图 6-91

图像细节步骤 91

1.  在“阶段”下，单击任务链接继续。见图 [6-91](#Fig91) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig92_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig92_HTML.png)

图 6-92

图像细节步骤 92

1.  针对该任务，单击 New 创建新的服务连接。见图 [6-92](#Fig92) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig93_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig93_HTML.png)

图 6-93

图像细节步骤 93

1.  选择 Azure 订阅作为身份验证方法，并选择订阅、资源组和命名空间作为默认值。输入服务连接的名称，然后单击保存。见图 [6-93](#Fig93) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig94_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig94_HTML.png)

图 6-94

图像细节步骤 94

1.  继续细节，如图 [6-94](#Fig94) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig95_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig95_HTML.png)

图 6-95

图像细节步骤 95

1.  这项任务将把容器部署到 Kubernetes 中，这可以使用您在构建管道中发布的 YAML 文件中编写的指令来完成。提供您在构建任务中复制的 YAML 文件的路径，而不是文件路径。见图 [6-95](#Fig95) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig96_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig96_HTML.png)

图 6-96

图像细节步骤 96

1.  输入秘密详情，如图 [6-96](#Fig96) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig97_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig97_HTML.png)

图 6-97

图像细节步骤 97

1.  选择最新版本以确保部署工作正常。见图 [6-97](#Fig97) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig98_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig98_HTML.png)

图 6-98

图像细节步骤 98

1.  当通过更改应用程序的源代码将容器应用程序的下一个版本部署到 Kubernetes 中时，您应该获得最新的容器应用程序。要做到这一点，可以使用 Kubectl `set`命令来设置容器的版本；见图 [6-98](#Fig98) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig99_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig99_HTML.png)

图 6-99

图像细节步骤 99

1.  增加如图 [6-99](#Fig99) 所示的强制细节。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig100_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig100_HTML.png)

图 6-100

图像细节步骤 100

1.  因为每次构建都会创建一个新版本的容器，所以使用带有 Kubectl `set`命令的构建 ID 变量来设置构建的镜像的相同版本，作为要在 Kubernetes 中部署的镜像的最新版本。参见图 [6-100](#Fig100) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig101_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig101_HTML.png)

图 6-101

图像细节步骤 101

1.  转到变量部分，添加名为 ACR 的变量名。使用相同的 ACR 服务器 DNS。参见图 [6-101](#Fig101) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig102_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig102_HTML.png)

图 6-102

图像细节步骤 102

1.  遵循图 [6-102](#Fig102) 所示的步骤。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig103_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig103_HTML.png)

图 6-103

图像细节步骤 103

1.  现在你将对应用程序做一个小小的改动，如图 [6-103](#Fig103) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig104_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig104_HTML.png)

图 6-104

图像细节步骤 104

1.  对`Index.chtml`文件进行更改；参见图 [6-104](#Fig104) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig105_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig105_HTML.png)

图 6-105

图像细节步骤 105

1.  添加相关注释，然后提交并推送更改，如图 [6-105](#Fig105) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig106_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig106_HTML.png)

图 6-106

图像细节步骤 106

1.  您可以在 Pipelines 部分下查看添加的注释和更改，如图 [6-106](#Fig106) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig107_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig107_HTML.png)

图 6-107

图像细节步骤 107

1.  验证更改。参见图 [6-107](#Fig107) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig108_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig108_HTML.png)

图 6-108

图像细节步骤 108

1.  单击并检查状态。参见图 [6-108](#Fig108) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig109_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig109_HTML.png)

图 6-109

图像细节步骤 109

1.  您可以查看所有任务的执行情况；参见图 [6-109](#Fig109) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig110_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig110_HTML.png)

图 6-110

图像细节步骤 110

1.  转到 Azure Portal 并验证用标签推送的更改。它们可以通过选择容器注册➤服务➤仓库看到。参见图 [6-110](#Fig110) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig111_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig111_HTML.png)

图 6-111

图像细节步骤 111

1.  现在在 Azure DevOps 门户中，在 Release 下，可以看到需要部署的相关变更的细节。参见图 [6-111](#Fig111) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig112_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig112_HTML.png)

图 6-112

图像细节步骤 112

1.  可以查看部署进度。参见图 [6-112](#Fig112) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig113_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig113_HTML.png)

图 6-113

图像细节步骤 113

1.  通过点击日志，您可以看到正在执行的步骤。参见图 [6-113](#Fig113) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig114_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig114_HTML.png)

图 6-114

图像细节步骤 114

1.  从 Azure 门户中，选择 Kubernetes 服务。在 Kubernetes 资源部分下，选择工作负载。在“部署”下，将列出最新的部署。参见图 [6-114](#Fig114) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig115_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig115_HTML.png)

图 6-115

图像细节步骤 115

1.  单击列出的部署以查看更多详细信息。参见图 [6-115](#Fig115) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig117_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig117_HTML.png)

图 6-117

图像细节步骤 117

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig116_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig116_HTML.png)

图 6-116

图像细节步骤 116

1.  单击概述，然后单击连接，查看使用 Azure CLI 和示例命令连接群集的方式。按照图 [6-116](#Fig116) 所示步骤，使用云壳连接 AKS。

1.  复制并输入如图 [6-117](#Fig117) 所示的命令。您可以托管外部 IP。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig118_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig118_HTML.png)

图 6-118

图像细节步骤 118

1.  在浏览器中输入 IP 并查看托管的应用程序。参见图 [6-118](#Fig118) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig119_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig119_HTML.png)

图 6-119

图像细节步骤 119

1.  现在，一旦验证了 CI/CD 实施。参见图 [6-119](#Fig119) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig120_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig120_HTML.png)

图 6-120

图像细节步骤 120

1.  对`index`文件做小改动，如图 [6-120](#Fig120) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig121_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig121_HTML.png)

图 6-121

图像细节步骤 121

1.  提交并推动新的变革。参见图 [6-121](#Fig121) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig122_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig122_HTML.png)

图 6-122

图像细节步骤 122

1.  在 GitHub 上也可以看到变化，如图 [6-122](#Fig122) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig123_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig123_HTML.png)

图 6-123

图像细节步骤 123

1.  当然，你可以在 Azure DevOps Portal 中的 Pipelines 下查看这些变化，如图 [6-123](#Fig123) 所示。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig124_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig124_HTML.png)

图 6-124

图像细节步骤 124

1.  在 Releases 下，您可以看到部署已经成功。这是因为我启用了持续部署触发器。参见图 [6-124](#Fig124) 。

![../images/517807_1_En_6_Chapter/517807_1_En_6_Fig125_HTML.png](../images/517807_1_En_6_Chapter/517807_1_En_6_Fig125_HTML.png)

图 6-125

图像细节步骤 125

1.  在浏览器中，刷新页面以验证更改。参见图 [6-125](#Fig125) 。

您可以看到，应用程序已经启动并运行良好，只是做了一些更改。& # x1F60A

## 摘要

如果您遵循了本章中的步骤，CI/CD 将在您的 web 应用程序中成功实现。这是一个好主意，密切遵循这些步骤两到三次。现在，作为练习的一部分，尝试部署一个 web API，而不是 Web 应用程序。在构建过程中，您只需更改很少的几个步骤。让我知道你是如何通过本章和其他章节的循序渐进的方法来学习的。我希望这本书加快了你对 Azure Kubernetes 服务的学习之旅。感谢您在学习过程中阅读本书。祝你好运，祝你 Azure 学习愉快。